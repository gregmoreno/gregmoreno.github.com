
<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta charset="utf-8">
	<title>Greg Moreno</title>

	<meta name="author" content="Greg Moreno">
	
	<meta name="description" content="How to Create a Wrapper Gem for Service APIs - Part 1 APIs are getting more and more popular as apps and services move to the cloud. Whenever you &hellip;">

	<meta name="HandheldFriendly" content="True" />
	<meta name="MobileOptimized" content="320" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<link href="/atom.xml" rel="alternate" title="Greg Moreno" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Open+Sans:700,400" />
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_dark.min.css" />
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>


<body class="home-template">
  <header id="site-head">
  <div class="vertical">
    <div id="site-head-content" class="inner">
      <h1 class="blog-title"><a class="no-rollover" href="/">Greg Moreno</a></h1>
      <h2 class="blog-description">
         <a class="no-rollover" href="/archives">Archives</a>
      </h2>
    </div>
  </div>
</header>

  <main class="content" role="main">
    



  
    <article class="post">
      
	
		
	
	<header class="post-header">
		<h2 class="post-title">
			
			<a href="/how-to-create-a-wrapper-gem-for-service-apis-part-1/">
			
				How to Create a Wrapper Gem for Service APIs - Part 1</a>
		</h2>
	</header>
	<section class="post-excerpt">
		<p>APIs are getting more and more popular as apps and services move to the cloud. Whenever you need to integrate a popular web service API into your Ruby app, 99.99% of the time there already exists a gem ready for use. That is a testament to how active Ruby developers are in supporting the community.</p>

<p>Even if integrating with the popular APIs is not in your radar, you may still have a need to create an API wrapper for internal use. For example, if your Rails application has grown tremendously (congratulations!), you may eventually need to adopt a services architecture to support upcoming features and make things manageable.</p>

<p>I created the <a href="https://github.com/gregmoreno/openamplify">gem for the Open Amplify API</a> as part of my exploration to data mining. When I first created it, my primary goal was simply to wrap the API. Though I still didn&rsquo;t write spaghetti code, it wasn&rsquo;t a good example of structured code either. Two years later (yep, that&rsquo;s how long I let the code rot), I decided to re-write the gem and adopt the architecture from the Twitter gem. It was a good exercise because not only I updated the gem for the newest API version, I also learned a great deal on how to write a gem.</p>

<h3>Setup the project</h3>

<p>We will create a wrapper for the fictitious Awesome API and thus call our gem &lsquo;awesome&rsquo;. To get things started, let&rsquo;s use bundler to set up our initial code.</p>

<pre><code>$&gt; bundle gem awesome
create awesome/Gemfile
create awesome/Rakefile
create awesome/LICENSE
create awesome/README.md
create awesome/.gitignore
create awesome/awesome.gemspec
create awesome/lib/awesome.rb
create awesome/lib/awesome/version.rb
Initializating git repo in /Users/greg/dev/code/awesome
</code></pre>

<p>This is the standard directory structure and naming convention of Ruby gems. The files Gemfile, Rakefile, and .gitignore are not necessary but they would be very useful while developing your gem.</p>

<h3>Gem dependencies</h3>

<p>All gem dependencies should go into awesome.gemspec and not in Gemfile. Inside your Gemfile, the line &lsquo;gemspec&rsquo; takes care of identifying the gems you needed in your local.</p>

<pre><code>$&gt; more Gemfile
source 'https://rubygems.org'

# Specify your gem's dependencies in awesome.gemspec
gemspec
</code></pre>

<h3>Versioning</h3>

<p>You specify the version of your gem inside lib/awesome/version.rb</p>

<pre><code>$&gt; more lib/awesome/version.rb
module Awesome
  VERSION = "0.0.1"
end
</code></pre>

<p>You may be wondering how is this used by the gem. Take a peek at awesome.gemspec and you&rsquo;ll see that Awesome::VERSION is used by the .gemspec file.</p>

<pre><code>$&gt; more awesome.gemspec
require File.expand_path('../lib/awesome/version', __FILE__)

Gem::Specification.new do |gem|
gem.authors = ["Greg Moreno"]
gem.email = ["greg.moreno@gmail.com"]
gem.description = %q{TODO: Write a gem description}
gem.summary = %q{TODO: Write a gem summary}
gem.homepage = ""

gem.files = `git ls-files`.split($\)
gem.executables = gem.files.grep(%r{^bin/}).map{ |f| File.basename(f) }
gem.test_files = gem.files.grep(%r{^(test|spec|features)/})
gem.name = "awesome"
gem.require_paths = ["lib"]
gem.version = Awesome::VERSION
end
</code></pre>

<h3>Additional modules and classes</h3>

<p>You can write all your code in the file lib/awesome.rb and it would still work. However, in the spirit of making code maintainable, it is highly recommended that you put your classes and modules under the directory lib/awesome just like what we did with lib/awesome/version.rb</p>

<h3>Testing the gem</h3>

<p>We will use minitest but you can always use any test framework you prefer. For our test setup, we need to do the ff:</p>

<ul>
<li>Setup our test directory manually since bundler didn&rsquo;t do this for us.</li>
<li>Create a rake task to run our tests.</li>
<li>Specify gem dependencies in our common test helper file.</li>
</ul>


<p>And the steps and code below.</p>

<pre><code>$&gt; mkdir test
$&gt; touch test/helper.rb
$&gt; mkdir test/awesome
$&gt; touch test/awesome/awesome_test.rb

# Rakefile
require 'bundler/gem_tasks'

require 'rake/testtask'
Rake::TestTask.new do |test|
  test.libs &lt;&lt; 'lib' &lt;&lt; 'test'
  test.ruby_opts &lt;&lt; "-rubygems"
  test.pattern = 'test/**/*_test.rb'
  test.verbose = true
end

# test/helper.rb
require 'awesome'
require 'minitest/spec'
require 'minitest/autorun'
</code></pre>

<p>Now that we have our testing in place, let&rsquo;s write a simple test and see if everything works.</p>

<pre><code># test/awesome/awesome_test.rb
require 'helper'

describe Awesome do
  it 'should have a version' do
    Awesome::VERSION.wont_be_nil
  end
end

# Then, let's run the test
$&gt; rake test
(in /Users/greg/dev/code/awesome)
/Users/greg/.rbenv/versions/1.9.2-p290/bin/ruby -I"lib:lib:test" -rubygems "/Users/greg/.rbenv/versions/1.9.2-p290/lib/ruby/1.9.1/rake/rake_test_loader.rb" "test/awesome/awesome_test.rb"
Loaded suite /Users/greg/.rbenv/versions/1.9.2-p290/lib/ruby/1.9.1/rake/rake_test_loader
Started
.
Finished in 0.000695 seconds.

1 tests, 1 assertions, 0 failures, 0 errors, 0 skips

Test run options: --seed 55984
</code></pre>

<p>Perfect! Now, let&rsquo;s start working on the juicy parts of our gem.</p>

<h3>Configuration</h3>

<p>Every webservice API would definitely require a per-user configuration and your gem should be able to support that. For example in the Twitter gem, some methods require authentication and you setup the default configuration with this:</p>

<pre><code>Twitter.configure do |config|
  config.consumer_key = YOUR_CONSUMER_KEY
  config.consumer_secret = YOUR_CONSUMER_SECRET
  config.oauth_token = YOUR_OAUTH_TOKEN
  config.oauth_token_secret = YOUR_OAUTH_TOKEN_SECRET
end
</code></pre>

<p>Every API has different options but if you are wrapping a webservice, the options often fall into two categories - connections and functional options. For example,  connection-related options include the endpoint, user agent, and authentication keys while functional options include request format (e.g. json), number of pages to return and other parameters required by specific API functions. In some APIs, the  api key is passed as a parameter to GET calls so while it may be connection-related, it is better to group it with parameter options so you can easily encode all parameters in a single call.Our Awesome API is simple and will not deal with OAuth like the Twitter gem does. For the configuration, we should be able to do this:</p>

<pre><code>Awesome.api_key = 'YOUR_API_KEY'
Awesome.format = :json
# Other options are: user_agent, method
</code></pre>

<p>Now, let&rsquo;s write some tests. Of course, these should fail at first :)</p>

<pre><code># test/awesome/configuration_test.rbrequire 'helper'

describe 'configuration' do
  describe '.api_key' do
    it 'should return default key' do
      Awesome.api_key.must_equal Awesome::Configuration::DEFAULT_API_KEY
    end
  end

  describe '.format' do
    it 'should return default format' do
      Awesome.format.must_equal Awesome::Configuration::DEFAULT_FORMAT
    end
  end

  describe '.user_agent' do
    it 'should return default user agent' do
      Awesome.user_agent.must_equal Awesome::Configuration::DEFAULT_USER_AGENT
    end
  end

  describe '.method' do
    it 'should return default http method' do
      Awesome.method.must_equal Awesome::Configuration::DEFAULT_METHOD
    end
  end
end
</code></pre>

<p>As I mentioned before, the best way to write your gem (or any program for that matter) is to cleary separate the functionalities into modules and classes. In our case, we will put all configuration defaults inside a module (i.e. lib/awesome/configuration.rb). We also want to provide class methods for the module Awesome which we can easily do using Ruby&rsquo;s &lsquo;extend&rsquo;.</p>

<pre><code># lib/awesome/configuration.rb

module Awesome
  module Configuration
    VALID_CONNECTION_KEYS = [:endpoint, :user_agent, :method].freeze
    VALID_OPTIONS_KEYS = [:api_key, :format].freeze
    VALID_CONFIG_KEYS = VALID_CONNECTION_KEYS + VALID_OPTIONS_KEYS

    DEFAULT_ENDPOINT = 'http://awesome.dev/api'
    DEFAULT_METHOD = :get
    DEFAULT_USER_AGENT = "Awesome API Ruby Gem #{Awesome::VERSION}".freeze

    DEFAULT_API_KEY = nil
    DEFAULT_FORMAT = :json

    # Build accessor methods for every config options so we can do this, for example:
    # Awesome.format = :xml
    attr_accessor *VALID_CONFIG_KEYS

    # Make sure we have the default values set when we get 'extended'
    def self.extended(base)
      base.reset
    end

    def reset
      self.endpoint = DEFAULT_ENDPOINT
      self.method = DEFAULT_METHOD
      self.user_agent = DEFAULT_USER_AGENT

      self.api_key = DEFAULT_API_KEY
      self.format = DEFAULT_FORMAT
    end

  end # Configuration
end

# lib/awesome.rb
require 'awesome/version'
require 'awesome/configuration'

module Awesome
  extend Configuration
end

$&gt; rake test
(in /Users/greg/dev/code/awesome)
/Users/greg/.rbenv/versions/1.9.2-p290/bin/ruby -I"lib:lib:test" -rubygems "/Users/greg/.rbenv/versions/1.9.2-p290/lib/ruby/1.9.1/rake/rake_test_loader.rb" "test/awesome/awesome_test.rb" "test/awesome/configuration_test.rb"
Loaded suite /Users/greg/.rbenv/versions/1.9.2-p290/lib/ruby/1.9.1/rake/rake_test_loader
Started
.....
Finished in 0.001600 seconds.

5 tests, 5 assertions, 0 failures, 0 errors, 0 skips
</code></pre>

<p>Our gem will not be awesome if we don&rsquo;t support a &lsquo;configure&rsquo; block like what the Twitter gem does. We want to setup the configuration like this:</p>

<pre><code>Awesome.configure do |config|
  config.api_key = 'YOUR_API_KEY'
  config.method = :post
  config.format = :json
end
</code></pre>

<p>Fortunately, it&rsquo;s an easy fix. We just need to add a &lsquo;configure&rsquo; method to the Configuration module. We also update our tests to make sure this new method works.</p>

<pre><code># lib/awesome/configuration.rb
def configure
  yield self
end

# test/awesome/configuration_test.rb
after do
  Awesome.reset
end

describe '.configure' do
  Awesome::Configuration::VALID_CONFIG_KEYS.each do |key|
    it "should set the #{key}" do
      Awesome.configure do |config|
        config.send("#{key}=", key)
        Awesome.send(key).must_equal key
      end
    end
  end
end
</code></pre>

<p>Before we move on, let&rsquo;s take a second look at our configuration tests. We have tests for checking default values and setting-up new ones.  What if we added a new configuration key for our gem? The &lsquo;configure&rsquo; tests will be able to handle the new key but we still have to add another test for checking the default value. And we don&rsquo;t want to right another test code, right?  More importantly, we don&rsquo;t want our tests to yield false positives. If we fail to add the &lsquo;default value&rsquo; check, our tests will still pass even though  we forgot to set a default value.Let us remove all our default value tests and replace it with code that relies on VALID_CONFIG_KEYS instead.</p>

<pre><code># test/awesome/configuration_test.rb
Awesome::Configuration::VALID_CONFIG_KEYS.each do |key|
  describe ".#{key}" do
    it 'should return the default value' do
      Awesome.send(key).must_equal Awesome::Configuration.const_get("DEFAULT_#{key.upcase}")
    end
  end
end

$&gt; rake test
(in /Users/greg/dev/code/awesome)
/Users/greg/.rbenv/versions/1.9.2-p290/bin/ruby -I"lib:lib:test" -rubygems "/Users/greg/.rbenv/versions/1.9.2-p290/lib/ruby/1.9.1/rake/rake_test_loader.rb" "test/awesome/awesome_test.rb" "test/awesome/configuration_test.rb"
Loaded suite /Users/greg/.rbenv/versions/1.9.2-p290/lib/ruby/1.9.1/rake/rake_test_loader
Started
...........
Finished in 0.002935 seconds.

11 tests, 11 assertions, 0 failures, 0 errors, 0 skips

Test run options: --seed 21540
</code></pre>

<h3>Configuring clients</h3>

<p>Our end goal is to wrap API calls that fits nicely into our application and the common approach to do that is to wrap the API calls under a &lsquo;Client&rsquo; class. Depending on the size of the API you want to support, the Client class maybe delegating the method calls to other classes and modules but from the point of view your program, the action happens inside the Client class. There are two ways to configure the Client class:</p>

<ul>
<li>It inherits the configuration values defined in the Awesome module;</li>
<li><p>It overrides the configuration values per client</p>

<p>  # Use the values defined in the Awesome module
  client = Awesome::Client.new
  client.make_me_awesome(&lsquo;gregmoreno&rsquo;)</p>

<p>  client_xml = Awesome::Client.new :format => :xml
  client_json = Awesome::Client.new :format => :json</p></li>
</ul>


<p>We are not going to show our tests in here but if you are interested, you can view the <a href="https://github.com/gregmoreno/awesome/blob/master/test/awesome/client_test.rb">test code from the github</a> repository. Instead, we show the code that handles the two scenarios for client configuration.</p>

<pre><code># lib/awesome/client.rb

module Awesome
  class Client

    # Define the same set of accessors as the Awesome module
    attr_accessor *Configuration::VALID_CONFIG_KEYS

    def initialize(options={})
      # Merge the config values from the module and those passed
      # to the client.
      merged_options = Awesome.options.merge(options)

      # Copy the merged values to this client and ignore those
      # not part of our configuration
      Configuration::VALID_CONFIG_KEYS.each do |key|
        send("#{key}=", merged_options[key])
      end
    end

  end # Client
end
</code></pre>

<p>We also need to update our Awesome module. First, we need to require the new file  awesome/client.rb so it will be loaded when we require the gem.  Second, we need to implement a method that returns all the configuration values inside the Awesome module. Since this is still about configuration, our new method should go inside the Configuration module.</p>

<pre><code># lib/awesome/configuration.rb
def options
  Hash[ * VALID_CONFIG_KEYS.map { |key| [key, send(key)] }.flatten ]
end
</code></pre>

<p>We&rsquo;re finally done with the configuration part of our gem. I know it&rsquo;s a lot of work for a simple task but we managed to put a good structure in our code. Plus, we learned how to make our tests less brittle, and use Ruby&rsquo;s awesome power to make our code better.   In our next installment, we&rsquo;ll discuss requests and error handling.</p>

	</section>
	<span class="post-meta">07 Jun 2012</span>


    </article>

  
    <article class="post">
      
	
	<header class="post-header">
		<h2 class="post-title">
			
			<a href="/create-your-own-rails-3-engine/">
			
				Create Your Own Rails 3 Engine</a>
		</h2>
	</header>
	<section class="post-excerpt">
		<p>Engine is an interesting feature of Rails. Engines are miniature applications that live inside your application and they have structure that you would normally find in a typical Rails application. If you have used the Devise gem, which itself is an engine, you know the benefits of being able to add functionality to your application with just a few lines of code. Another great benefit of engines is when you or your team are maintaining a number of applications the common functionalities can be extracted into engines.</p>

<p>Engines are already available prior to Rails 3 but it is not a core feature of the framework. As such, engine developers resorted to monkey-patching which, oftentimes, lead to engines breaking when Rails gets updated. In Rails 3.1, engines are now supported by the framework and there is now a clealy defined place where to hook your engines into Rails.</p>

<p>Now, let us go through the steps of building a simple engine. We will be working on authentication engine (like Devise) that allows users of your application to use their Twitter or Facebook credentials.</p>

<pre><code># This is the app that will use our engine
$&gt; rails new social_app

# This is our engine
$&gt; rails plugin new undevise --mountable
</code></pre>

<p>The –mountable option tells Rails you want to generate a mountable plugin, commonly known as engine. When you look at the directory structure of your engine, it is much different from your Rails app. The engine has controllers, models, views, mailers, lib, and even its own config/routes.rb (didn’t we just said it is a miniature Rails app).</p>

<h3>Include the engine in your app</h3>

<p>Just like any gem, you should update your app’s Gemfile to use the engine we created.</p>

<pre><code># social_app/Gemfile
gem 'undevise', :path =&gt; '../undevise'
</code></pre>

<p>Of course, you can set :path to any location or if it is in a git repository, you can use the :git option. If you are developing your engine alongside your app, a better approach is to use gem groups in your Gemfile. For example:</p>

<pre><code>group :development do
  gem 'undevise', :path =&gt; '../undevise'
end

group :production do
  gem 'undevise', :git =&gt; 'git://github.com/yourname/undevise.git'
end
</code></pre>

<p>After adding the engine in your Gemfile, let’s make sure all dependencies are available for the application. If everything works, you should be able to see a reference to undevise inside Gemfile.lock</p>

<pre><code>$&gt; cd social_app
$&gt; bundle install
$&gt; more Gemfile.lock
PATH
  remote: ../undevise
  specs:
    undevise (0.0.1)
      rails (~&gt; 3.2.1)
</code></pre>

<h3>Mount the engine</h3>

<p>Next, we will mount the engine and see if we can route requests to it. What this does is make sure requests starting with /auth will be passed to our engine.</p>

<pre><code># social_app/config/routes.rb
SocialApp::Application.routes.draw do
  mount Undevise::Engine, :at =&gt; '/auth'
end

# Run the social app. Make sure you are in the social_app directory.
$&gt; rails s

# Then visit http://localhost:3000/auth
</code></pre>

<p>When you visit ‘/auth‘, you will get a routing error because you haven’t defined any routes in your engine yet.</p>

<pre><code># undevise/config/routes.rb
Undevise::Engine.routes.draw do
  root :to =&gt; 'auth#index'
end
</code></pre>

<p>Remember even though your engine is mounted at ‘/auth’, what your engine sees is the path after the ‘/auth’. Routes in engines are namespaced to avoid conflicts with your app. You can change the mounted path in your Rails app anytime and your engine wouldn’t care. Let’s try again and see what Rails would tell us.</p>

<pre><code>$&gt; cd social_app
$&gt; rails s
</code></pre>

<p>Perfect! Now we know the request is being passed to our engine. We now just have to define our controller.</p>

<pre><code>$ cd undevise
$ rails g controller auth

# undevise/app/controllers/undevise/auth_controller.rb
module Undevise
  class AuthController &lt; ApplicationController
    def index
      render :text =&gt; 'Hello world'
    end

  end
end

# Now, visit http://localhost:3000/auth
</code></pre>

<p>Cool! We have the obligatory hello world program working. At the the risk of sounding like a broken record, remember your engine code should be namespaced. If you forget this, strange things will happen to your application and Rails will not usually complain about it.</p>

<h3>Gem dependencies</h3>

<p>I’m sure your idea for an engine is very far from what we have shown so far. When you generate an engine, it also creates a .gemspec file. While in your Rails app you list the gems in Gemfile, in your engine you list the gems inside the .gemspec file. This can be confusing because the engine also contains a Gemfile.</p>

<pre><code>$&gt; cd undevise
$&gt; more Gemfile

source "http://rubygems.org"

# Declare your gem's dependencies in undevise.gemspec.
# Bundler will treat runtime dependencies like base dependencies, and
# development dependencies will be added by default to the :development group.
gemspec
</code></pre>

<p>As you can see, there is no need to list the gems your engine needs in the Gemfile. The line ‘gemspec’ makes sure the gems you listed in your .gemspec file are installed when you run bundle install.</p>

<p>Now, let’s add some gems in our engine and see how it will affect our Rails app.</p>

<pre><code># undevise/undevise.gemspec
s.add_dependency "rails", "~&gt; 3.2.1"
s.add_dependency "omniauth"
s.add_dependency "omniauth-twitter"
s.add_dependency "omniauth-facebook"


$ cd social_app
$ bundle install
$ more Gemfile.lock
PATH
  remote: ../undevise
  specs:
    undevise (0.0.1)
      omniauth
      omniauth-facebook
      omniauth-twitter
      rails (~&gt; 3.2.1)
</code></pre>

<p>Here we can see the gems we specifed in undevise/undevise.gemspec are also included in the main Rails app.</p>

<h3>Configure OmniAuth</h3>

<p>If you are using omniauth directly in your app, your will configuration will definitely be in the file config/initializers/omniauth.rb. Since our engine is pretty much just another Rails app, it will also have its own config/initializers/omniauth.rb file. The only consideration with regards to the configuration is where would the Twitter or Facebook credentials be located. You definitely don’t want to embed it in your engine.</p>

<p>Our solution is to store the credentials inside a config/twitter.yml file (or config/facebook.yml) inside your main Rails app. Then have our engine pull the values out of these files to configure omniauth.</p>

<pre><code>$&gt; cd undevise/config
$&gt; mkdir initializers
$&gt; touch initializers/omniauth.rb

# We have to create the initializers directory because it not created by default.

# undevise/config/initializers/omniauth.rb
providers = %w(twitter facebook).inject([]) do |providers, provider|
  fpath = Rails.root.join('config', "#{provider}.yml")

  if File.exists?(fpath)
    config = YAML.load_file(fpath)
    providers &lt;&lt; [ provider, config['consumer_key'], config['consumer_secret'] ]
  end

  providers
end

raise 'You have not created config/twitter.yml or config/facebook.yml' if providers.empty?

Rails.application.config.middleware.use OmniAuth::Builder do
  providers.each do |p|
    provider *p
  end
end
</code></pre>

<p>Now, let’s go back to our main Rails app and start the server.</p>

<pre><code>$&gt; cd social_app
$&gt; rails s
=&gt; Booting WEBrick
=&gt; Rails 3.2.1 application starting in development on http://0.0.0.0:3000
=&gt; Call with -d to detach
=&gt; Ctrl-C to shutdown server
Exiting
/Users/greg/dev/tmp/ruby/engine-tutorial/undevise/config/initializers/omniauth.rb:12:in `&lt;top (required)&gt;': You have not created config/twitter.yml or config/facebook.yml (RuntimeError)
</code></pre>

<p>Oops! We forgot to create our Twitter or Facebook configuration file. In your main Rails app, go ahead and create config/twitter.yml. If you are not familiar with Twitter apps, visit their developer site at <a href="https://dev.twitter.com/">https://dev.twitter.com/</a></p>

<h3>Gemfile dependencies and sub-depencies</h3>

<pre><code># social_app/config/twitter.yml
consumer_key:  'APP_CONSUMER_KEY'
consumer_secret: 'APP_CONSUMER_SECRET'

$&gt; rails s
=&gt; Booting WEBrick
=&gt; Rails 3.2.1 application starting in development on http://0.0.0.0:3000
=&gt; Call with -d to detach
=&gt; Ctrl-C to shutdown server
Exiting
/Users/greg/dev/tmp/ruby/engine-tutorial/undevise/config/initializers/omniauth.rb:12:in `&lt;top (required)&gt;': uninitialized constant OmniAuth (NameError)
     from /Users/greg/.rbenv/versions/1.9.3-p0/lib/ruby/gems/1.9.1/gems/railties-3.2.1/lib/rails/engine.rb:588:in `block (2 levels) in &lt;class:Engine&gt;'
</code></pre>

<p>The NameError occurs because during the main Rails’ app boot up, Bundler will only require dependencies listed in the Gemfile but not the sub-dependencies. As you can see from Gemfile.lock, omniauth is not a direct dependency. You could list the gems in your main app’s Gemfile but that’s defeating the purpose of isolating the gem dependencies through your engine.</p>

<p>The solution right now is to require your dependencies inside your engine and the place to do that is inside lib/undevise/engine.rb</p>

<pre><code># undevise/lib/undevise/engine.rb
require 'omniauth'
require 'omniauth-twitter'
require 'omniauth-facebook'

module Undevise
  class Engine &lt; ::Rails::Engine
    isolate_namespace Undevise
  end
end
</code></pre>

<p>After listing required dependencies inside your engine, restart your main Rails app, then visit <a href="http://localhost:3000/auth/twitter/">http://localhost:3000/auth/twitter/</a></p>

<p>When you visit <a href="http://localhost:3000/auth/twitter/,">http://localhost:3000/auth/twitter/,</a> you should see the error above. The callback url is part of OmniAuth’s behaviour and should be fixed by adding a route in your engine and adding the method to handle it in your controller.</p>

<pre><code># undevise/config/routes.rb
Undevise::Engine.routes.draw do
  root :to =&gt; 'auth#index'
  match ':provider/callback' =&gt; 'auth#callback'
end

# undevise/app/controllers/undevise/auth_controller.rb
module Undevise
  class AuthController &lt; ApplicationController

    def index
      render :text =&gt; 'Hello world'
    end

    def callback
      render :text =&gt; "Hello from #{params[:provider]}"
    end

  end
end
</code></pre>

<p>If everything work fine, you should see a message from Twitter.</p>

<p>We only scratched the surface with Rails 3 engine. Your engine, much like any normal Rails app, can have models and migrations, javascripts, css, specs, etc. If you want to dig deeper into engines, I recommend Rails 3 in Action by Ryan Bigg and Yehuda Katz. It includes a whole chapter about engines, discussion of middleware, and how tests your engine.</p>

	</section>
	<span class="post-meta">29 May 2012</span>


    </article>

  
    <article class="post">
      
	
	<header class="post-header">
		<h2 class="post-title">
			
			<a href="/architecture-the-lost-years-by-robert-martin/">
			
				Architecture the Lost Years by Robert Martin</a>
		</h2>
	</header>
	<section class="post-excerpt">
		<p><a href="http://www.youtube.com/watch?v=WpkDN78P884" title="Architecture the Lost Years by Robert Martin"><img src="http://img.youtube.com/vi/WpkDN78P884/0.jpg" alt="Architecture the Lost Years by Robert Martin" /></a></p>

<p>http://youtu.be/WpkDN78P884</p>


	</section>
	<span class="post-meta">06 Mar 2012</span>


    </article>

  
    <article class="post">
      
	
	<header class="post-header">
		<h2 class="post-title">
			
			<a href="/more-ruby-tips-and-tricks/">
			
				More Ruby Tips and Tricks</a>
		</h2>
	</header>
	<section class="post-excerpt">
		<h3>String to number conversion gotcha</h3>

<pre><code>&gt;&gt; Float('3.14159')
=&gt; 3.14159 
&gt;&gt; '3.14159'.to_f
=&gt; 3.14159 

# However, Float() method will return an exception if given
# a bad input while to_f() will ignore everything from the 
# offending character.

&gt;&gt; Float('3.x14159')
ArgumentError: invalid value for Float(): "3.x14159"
  from (irb):4:in 'Float'
  from (irb):4

&gt;&gt; '3.x14159'.to_f
=&gt; 3.0


# Similar case with to_i() and Integer().

&gt;&gt; Integer('19x69')
ArgumentError: invalid value for Integer(): "19x69"
  from (irb):15:in 'Integer'
  from (irb):15
  from /Users/greg/.rvm/rubies/ruby-1.9.2-p0/bin/irb:17:in '&lt;main&gt;'

&gt;&gt; '19x69'.to_i
=&gt; 19
</code></pre>

<h3>Case insensitive regular expression</h3>

<pre><code># Regex is case sensitive by default.
# Adding 'i' for insensitive match
puts 'matches' if  /AM/i =~ 'am'
</code></pre>

<h3>Hash is ordered in 1.9</h3>

<pre><code># new syntax in 1.9
h = {first: 'a', second: 'b', third: 'c'}

# hashes in 1.9 are ordered
h.each do |e|
  pp e
end
</code></pre>

<h3>Filter a list using several conditions</h3>

<pre><code>conditions = [
    proc { |i| i &gt; 5 },
    proc { |i| (i % 2).zero? },
    proc { |i| (i % 3).zero? }
  ]

matches = (1..100).select do |i|
  conditions.all? { |c| c[i] }
end
</code></pre>

<h3>Randomly pick an element from an array</h3>

<pre><code>&gt;&gt; [1,2,3,4,5].sample
=&gt; 2 
&gt;&gt; [1,2,3,4,5].sample
=&gt; 1 

# pick 2 random elements
&gt;&gt; [1,2,3,4,5].sample(2)
=&gt; [1, 5]
</code></pre>

<h3>List methods unique to a class</h3>

<pre><code># List all instance methods that starts with `re` including those inherited by String.

&gt;&gt; String.instance_methods.grep /^re/
=&gt; [:replace, :reverse, :reverse!, :respond_to?, :respond_to_missing?] 

# List methods unique to String, i.e. not include
# those defined by its ancestors.

&gt;&gt; String.instance_methods(false).grep /^re/
=&gt; [:replace, :reverse, :reverse!]
</code></pre>

<h3>Globbing key-value pairs</h3>

<pre><code>&gt;&gt; h = Hash['a', 1, 'b', 2]
=&gt; {"a"=&gt;1, "b"=&gt;2}

&gt;&gt; h = Hash[ [ ['a', 1], ['b', 2] ] ] 
=&gt; {"a"=&gt;1, "b"=&gt;2}

&gt;&gt; h = Hash[ 'a' =&gt; 1, 'b' =&gt; 2 ]
=&gt; {"a"=&gt;1, "b"=&gt;2}

# The first form is very useful for globbing key-value pairs in Rails’ routes. For example, if you have the following:

# route definition in Rails 3
match 'items/*specs' =&gt; 'items#specs'

# sample url
http://localhost:3000/items/year/1969/month/7/day/21

# params[:specs] will be set

&gt;&gt; params[:specs]
=&gt; "year/1969/month/7/day/21"

&gt;&gt; h = Hash[*params[:specs].split('/')]
=&gt; {"year"=&gt;"1969", "month"=&gt;"7", "day"=&gt;"21"}
</code></pre>

	</section>
	<span class="post-meta">03 Mar 2012</span>


    </article>

  
    <article class="post">
      
	
	<header class="post-header">
		<h2 class="post-title">
			
			<a href="/24-ruby-language-tips-and-tricks/">
			
				Ruby Tips and Tricks</a>
		</h2>
	</header>
	<section class="post-excerpt">
		<h3>Generate random numbers within a given range</h3>

<pre><code>irb(main):019:0&gt; rand(10..20)
=&gt; 12
irb(main):020:0&gt; rand(10...20) # works with exclusive range
=&gt; 16
</code></pre>

<h3>Dump your object using awesome_print</h3>

<pre><code># Install the gem first
gem install awesome_print

irb(main):001:0&gt; require 'ap'
=&gt; true
irb(main):002:0&gt; ap :a =&gt; 1, :b =&gt; 'greg', :c =&gt; [1,2,3]
{
    :a =&gt; 1,
    :b =&gt; "greg",
    :c =&gt; [
        [0] 1,
        [1] 2,
        [2] 3
    ]
}
=&gt; {:a=&gt;1, :b=&gt;"greg", :c=&gt;[1, 2, 3]}
</code></pre>

<h3>Concatenating strings</h3>

<pre><code>irb(main):005:0&gt; "abc" + "def"
=&gt; "abcdef"
irb(main):006:0&gt; "abc".concat("def")
=&gt; "abcdef"
irb(main):007:0&gt; x = "abc" "def"
=&gt; "abcdef"
</code></pre>

<h3>Include modules in a single line</h3>

<pre><code>class MyClass
  include Module1, Module2, Module3
  # However, the modules are included in reverse order. Confusing eh!
end
</code></pre>

<h3>Instance variable interpolation</h3>

<pre><code>irb(main):008:0&gt; @name = "greg"
=&gt; "greg"
irb(main):009:0&gt; "my name is #{@name}"
=&gt; "my name is greg"
irb(main):010:0&gt; "my name is #@name"
=&gt; "my name is greg"
</code></pre>

<p>I still prefer the curly braces.</p>

<h3>Syntax checking</h3>

<pre><code>$ ruby -c facu.rb 
facu.rb:12: syntax error, unexpected keyword_end, expecting $end
</code></pre>

<h3>Zipping arrays</h3>

<pre><code>irb(main):027:0&gt; names = %w(fred jess john)
=&gt; ["fred", "jess", "john"]
irb(main):028:0&gt; ages = [38, 47,91]
=&gt; [38, 47, 91]
irb(main):029:0&gt; locations = %w(spain france usa)
=&gt; ["spain", "france", "usa"]
irb(main):030:0&gt; names.zip(ages)
=&gt; [["fred", 38], ["jess", 47], ["john", 91]]
irb(main):031:0&gt; names.zip(ages, locations)
=&gt; [["fred", 38, "spain"], ["jess", 47, "france"], ["john", 91, "usa"]]
</code></pre>

<h3>Range into arrays</h3>

<pre><code>irb(main):034:0&gt; (10..20).to_a  # what I used to do
=&gt; [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
irb(main):035:0&gt; [*10..20]
=&gt; [10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]
</code></pre>

<h3>Using parameter as default value</h3>

<pre><code>irb(main):047:0&gt; def method(a, b=a); "#{a} #{b}"; end
=&gt; nil
irb(main):048:0&gt; method 1
=&gt; "1 1"
irb(main):049:0&gt; method 1, 2
=&gt; "1 2"
</code></pre>

<h3>Put regex match in a variable</h3>

<pre><code>irb(main):058:0&gt; s = "Greg Moreno"
=&gt; "Greg Moreno"
irb(main):059:0&gt; /(?&lt;first&gt;\w+) (?&lt;second&gt;\w+)/ =~ s
=&gt; 0
irb(main):060:0&gt; first
=&gt; "Greg"
irb(main):061:0&gt; second
=&gt; "Moreno"
</code></pre>

	</section>
	<span class="post-meta">09 Feb 2012</span>


    </article>

  
    <article class="post">
      
	
	<header class="post-header">
		<h2 class="post-title">
			
			<a href="/preventing-model-explosion-via-rails-serialization/">
			
				Preventing Model Explosion via Rails Serialization</a>
		</h2>
	</header>
	<section class="post-excerpt">
		<p>A great thing about ActiveRecord is you can easily add a new model to your application and play around with it as you progress. However, this power can easily be overused leading to unnecessary overhead in your code.</p>

<p>Consider the case where you have preferences for each user. For example, a user may opt to show or hide his email address, adjust his timezone, or language. One solution is to simply add new columns to the users table that correspond to each preference type. For example, you can have a ‘show_email’, ‘timezone’, ‘locale’ columns in the ‘users’ table, which can make your table become wide as you add more preferences options. Another option is to use a separate ‘preferences’ table.</p>

<pre><code>class User &lt; ActiveRecord::Base
  has_many :preferences
end

class Preferences &lt; ActiveRecord::Base
  belongs_to :user

  # name  - preference name
  # value - preference value
end
</code></pre>

<p>Note there is no user interface to add or remove ‘preferences’, i.e. the kinds of preferences are fixed. Of course, in the future you may add a new kind of preference but this kind of work is better done outside of the user interface. Since that is the case, there is no need to represent ‘preferences’ as a separate model.</p>

<p>One better alternative is to use Rails serialization to store the different kinds and user-specific values. The code would look like this:</p>

<pre><code>class User &lt; ActiveRecord::Base
  serialize :preferences, Hash
end

u = User.new
u.preferences = {:show_email =&gt; true, :locale =&gt; :en }
u.save

# somewhere in your view using haml
- if @user.preferences[:show_email]
  = @user.email
</code></pre>

<p>Using ‘serialize’ results in less code, fewer tables, and less overall complexity. However, with serialization you lose the ability to efficiently search the preferences data. The million-dollar question is do you need to query these preferences? Do you need a finder that returns all users who wants to show their email?</p>

<p>One issue I had with ‘serialize’ is that by using it, I expose the implementation details. In the display example above, it is obvious I had it stored as a Hash. I would rather hide this detail and present the preferences attributes as user attributes instead. I also want default values for every user.</p>

<p>For example:</p>

<pre><code>u = User.new  # automatically assigns the default preferences
u.preferences
=&gt; {:show_email =&gt; false, :locale =&gt; :en}

u.show_email = true  # I can change it like an attribute via @user.update_attributes(params[:user])
u.preferences
=&gt; {:show_email =&gt; true, :locale =&gt; :en}
</code></pre>

<p>I have created a module to support this. It is not a unique problem so others may have probably released a gem or plugin to do this. (I actually never bothered to search for one.) Nevertheless, it was a good exercise in metaprogramming.</p>

<p>To use my implementation, simply call ‘serializeable’ with the column you want to serialize and the default values.</p>

<pre><code>class User &lt; ActiveRecord::Base
  serializeable :preferences, :show_email =&gt; true, :locale =&gt; :en
end
</code></pre>

<p>Below is the implementation of ‘serializeable’. The convention is to save it under your ‘lib’ folder and include it in your ‘config/application.rb’ if you are using Rails 3.</p>

<pre><code>module AttributeSerializer
  module ActiveRecordExtensions
    module ClassMethods

      def serializeable(serialized, serialized_accessors={})  
        serialize serialized, serialized_accessors.class

        serialized_attr_accessor serialized, serialized_accessors
        default_serialized_attr serialized,  serialized_accessors
      end

      # Creates the accessors
      def serialized_attr_accessor(serialized, accessors)
        accessors.keys.each do |k|
          define_method("#{k}") do
            self[serialized] &amp;&amp; self[serialized][k]
          end

          define_method("#{k}=") do |value|
            self[serialized][k] = value
          end
        end
      end

      # Sets the default value of the serialized field
      def default_serialized_attr(serialized, accessors)
        method_name =  "set_default_#{serialized}"
        after_initialize method_name 

        define_method(method_name) do
          self[serialized] = accessors if self[serialized].nil?
        end
      end

    end
  end
end

class ActiveRecord::Base
  extend AttributeSerializer::ActiveRecordExtensions::ClassMethods
end
</code></pre>

<p>ActiveRecord is both easy and powerful. It can also lead to misuse and abuse. Even though you are adding just one model, remember that it is not just the model class itself. You are also adding the database migrations, unit tests, factories, finders, and validations that go along with the model. Next time you have a new requirement, see if serialization can do a better job.</p>

<p>Update: Adam Cuppy converted this code into a <a href="https://github.com/DYE/has_serialized">Rails plugin</a> while <a href="https://gist.github.com/842797">Jay added dynamic finder methods</a>. I also moved this into a gem I called <a href="https://github.com/gregmoreno/fancy_serializer">fancy_serializer</a>.</p>

	</section>
	<span class="post-meta">27 Jan 2011</span>


    </article>

  
    <article class="post">
      
	
	<header class="post-header">
		<h2 class="post-title">
			
			<a href="/ruby-101-improving-your-code-by-defining-methods-dynamically/">
			
				Ruby 101: Improving Your Code by Defining Methods Dynamically</a>
		</h2>
	</header>
	<section class="post-excerpt">
		<p>Let’s say you have a user and you want to check its role.</p>

<pre><code>class User
  attr_accessor :role
end

u = User.new
u.role = 'admin'

# somewhere in your code you check the role

if u.role == 'admin'
  puts 'admin'
elsif u.role == 'moderator'
  puts 'moderator'
elsif u.role == 'guest'
  puts 'guest'
end
</code></pre>

<p>Using a string value is bad code and you can improve this by using constants instead. But still, this is bad code becauses it exposes implementation details of your User class.</p>

<p>For our first improvement, we define methods that check the user’s role and hide the implementation of the role checking inside the User class.</p>

<pre><code>class User
  attr_accessor :role

  def is_admin?
    self.role == 'admin'
  end

  def is_moderator?
    self.role == 'moderator'
  end

  def is_guest?
    self.role == 'guest'
  end

end

u = User.new
u.role = 'guest'

if u.is_admin?
  puts 'admin'
elsif u.is_moderator?
  puts 'moderator'
elsif u.is_guest?
  puts 'guest'
end
</code></pre>

<p>Our first improvement is definitely better than the original but there are duplicate code in the role checking. You can eliminate the duplicate code by delegating the role checking to a single method.</p>

<pre><code>class User
  attr_accessor :role

  def is_admin?
    is_role? 'admin'
  end

  def is_moderator?
    is_role? 'moderator'
  end

  def is_guest?
    is_role? 'guest'
  end

  protected

  def is_role?(name)
    self.role == name
  end

end
</code></pre>

<p>Our second improvement is a classic refactoring technique and common in any modern programming language. In other words, there is nothing “Ruby” about it. Before you get bored, I will now show the Ruby version.</p>

<p>The Ruby version uses <code>#define_method</code> to further eliminate duplicate code.</p>

<pre><code>class User
  attr_accessor :role

  def self.has_role(name)
    define_method("is_#{name}?") do
      self.role == "#{name}"
    end
  end

  has_role :admin
  has_role :moderator
  has_role :guest

end
</code></pre>

<p>By using <code>#define_method</code>, we were able to add instance methods to our class User. You can check the new instance methods via irb.</p>

<pre><code>ruby-1.9.2-p0 &gt; User.instance_methods.grep /^is/
=&gt; [:is_admin?, :is_moderator?, :is_guest?, :is_a?]
</code></pre>

<p>Note that <code>#has_role</code> is just another method and as such you can modify it to accept several parameters, an array, or other class. For example, we can make ‘has_role’ accept a list of roles.</p>

<pre><code>class User
  attr_accessor :role

  def self.has_roles(*names)
    names.each do |name|
      define_method("is_#{name}?") do
        self.role == "#{name}"
      end
    end
  end

  has_roles :admin, :moderator, :guest
end
</code></pre>

	</section>
	<span class="post-meta">03 Jan 2011</span>


    </article>

  
    <article class="post">
      
	
	<header class="post-header">
		<h2 class="post-title">
			
			<a href="/how-to-use-openamplify-with-ruby/">
			
				How to Use OpenAmplify With Ruby</a>
		</h2>
	</header>
	<section class="post-excerpt">
		<p>The <a href="http://community.openamplify.com/blogs/quickstart/pages/overview.aspx">OpenAmplify API</a> reads text you supply and returns linguistic data explaining and classifying the content. What you do with that analysis is, in the fine tradition of APIs and mashups, up to you. Some possibilities might include pairing ads with articles, creating rich tag-clouds, or monitoring the tone of forum threads.</p>

<p>I created a ruby gem to simplify the use of the OpenAmplify API. It’s still in the early stages but should be enough to get you started.</p>

<p>In case you need a different format, OpenAmplify supports XML, JSON, RDF, CSV. It can also return the result as a fancy HTML page.</p>

<p>The source code is available in github <a href="http://github.com/gregmoreno/openamplify">http://github.com/gregmoreno/openamplify</a></p>

	</section>
	<span class="post-meta">06 Oct 2010</span>


    </article>

  
    <article class="post">
      
	
	<header class="post-header">
		<h2 class="post-title">
			
			<a href="/because-nothing-is-happening-on-the-screen/">
			
				Because Nothing Is Happening on the Screen</a>
		</h2>
	</header>
	<section class="post-excerpt">
		<blockquote><p>When we looked at the actual download speeds of the sites we tested, we found that there was no correlation between these and the perceived speeds reported by our users. About.com, rated slowest by our users, was actually the fastest site (average: 8 seconds). Amazon.com, rated as one of the fastest sites by users, was really the slowest (average: 36 seconds).
— <a href="http://www.uie.com/articles/download_time/">The Truth About Download Time</a></p></blockquote>

<p>Was Jakob Nielsen, the usability guru, wrong when he concluded that to avoid annoying users, <a href="http://www.useit.com/alertbox/9703a.html">pages should load in less than 10 seconds</a>? I think he&rsquo;s still right because it is no fun staring at the hourglass for 5 minutes. But when we tell our friends that <a href="http://www.flickr.com">Flickr</a> is faster than <a href="http://picasaweb.google.com">Picasa</a>, we don&rsquo;t say uploading a 1MB JPEG  takes 2.35 seconds in Flickr while it takes 4.86 seconds in Picasa. We just say Flickr is faster.</p>

<p>What is missing from Nielsen&rsquo;s conclusion is that when users say a website is slow, they talk about their feelings and not what they see in the stopwatch. This does not mean that programmers  should abandon measuring website performance. We still need to make that slow function run faster and there is no way to tell if we are progressing or not if we don&rsquo;t know the score.</p>

<p><a href="http://video.yahoo.com/video/play?vid=111582">Browsers follow a fetch-parse-flow-paint process to load web pages</a>. Given a URL, the fetch engine finds it and stores the page into a cache. The parse engine discovers the various HTML elements and produces a tree that represents the internal structure of the page. The flow engine handles the layout while the paint engine&rsquo;s job is to display the web page on the screen. Nothing unusual except that when the parse engine sees an image, it would stop and ask the fetch engine to read the image.  The parse engine continues only after it has determined the image&rsquo;s size. The end result is that the browser will wait until all the elements of the page has been processed before it shows the page. During this processing, all the user sees is a blank page.  This is how things work with the 1st widely-used web browser, <a href="http://en.wikipedia.org/wiki/Mosaic_%28web_browser%29">Mosaic</a>.</p>

<p>Netscape Navigator 1.0 took a different approach. When the parse engine sees an image, it still asks the fetch engine to load the image. The difference is that the parse engine will put a placeholder in the internal structure of the page to mark where the image is and let the flow and paint engines do their job.  When the image is loaded and analyzed, the paint engine does a repaint on the screen. This can happen several times if the page has a lot of images.  If you measure the overall time it takes to finalize the page display,  Mosaic is faster than Netscape.   But, users would say otherwise.  Mosaic lacks a sign of progress while the appearance of text, then an image, then another image makes users think that Netscape is faster.</p>

<p>My first encounter with the world wide web was in April 1996 while working as a student assistant at the <a href="http://www.asti.dost.gov.ph">Advanced Science Technology Institute</a>.  Back then, web pages consist mostly of text. Nowadays,  it is not uncommon for a page to contain lots of big images, embedded videos, references to several CSS and JavaScript files.  So while computing power and bandwidth has improved over the years,  content has also bloated making performance issues still a problem.</p>

<p>The common opinion is that if you want to improve a website&rsquo;s performance, you focus on the database, web server, and other back-end stuff. But, Yahoo! engineers found out that most optimization opportunities are present after the web server has responded with the page. When a URL is entered into the browser,  62% to 95% of the time is spent fetching the images, CSS, JavaScript contained in the page. It is clear that reducing the number of HTTP requests will also reduce response time.</p>

<p>The Yahoo! Exceptional Performance Group has identified <a href="http://developer.yahoo.com/performance/index.html">13 rules for making fast-loading web pages</a>. The group&rsquo;s lead, Steve Souders,  has also written a book on website performance.</p>

<p>Another cool product from the team is <a href="http://developer.yahoo.com/yslow/">YSlow</a> (nice name).  It analyzes a web page and tells you why it is slow based on the 13 rules. YSlow is a Firefox plugin and works alongside another web developer&rsquo;s indispensable tool, <a href="http://www.getfirebug.com/">Firebug</a>.  When I first used YSlow with <a href="http://www.schoolpad.ph">SchoolPad</a>, my initial grade was F (58). I first set out to address Rule #10 - Minify JavaScript. Since SchoolPad is written on Ruby on Rails, the <a href="http://synthesis.sbecker.net/pages/asset_packager">asset_packager plugin</a> came in handly in merging all my  CSS files and JavaScript files.  Using the plugin,  CSS and JavaScript files can be used in a single reference.The asset_packager is also smart. During development mode where CSS and JavaScripts files are often updated, the plugin references the original script files but in production mode it uses the minified versions of your CSS and JS files.  A few changes in your Capistrano file, then you can make the minification (is that a word?) process automatic every time you deploy your application. After a few more tweaks, my overall grade is now C (78) with an F on rules #2 (Use a CDN) and #3 (Add an expires header).  I can&rsquo;t address  rule #2 because that requires money and  #3 has to wait because it requires more Googling.</p>

<p>It might happen that you have an A in YSlow yet users complain that your website is slow.  Talk about an unlucky day. Don&rsquo;t despair. Maybe, it is time to focus on managing expectations instead of performance.</p>

<p>I wrote my first GUI-based program using Visual Basic on Windows 3.1. (I&rsquo;m sure <a href="http://www.workingwithrails.com/person/5774-evan-sagge">Evan</a> would argue that Basic is not a programming language). Any Visual Basic book would tell you to change the mouse pointer to an hourglass before a lengthy operation such as a database query, and change it back to the default pointer afterwards.</p>

<pre><code>Screen.MousePointer = vbHourglass
'Do lots of stuff.......
Screen.MousePointer = vbNormal
</code></pre>

<p>I think many people got addicted to the mouse pointer that along with the release of Windows 95 was a variety of themes that replace the default mouse pointer icon with a rocketship, a barking dog, or  a wiggling clownfish.</p>

<p>Anyway, back to the web. Wait! The reason the hourglass is widely used in desktop applications is because it tells the user that the application has accepted the action, and it is now working on it.  In your web apps, you should do the same.</p>

<p>Traditionally, when you click a link in a website, the browser sends a request to the server, receives a page, and repaints the content. Feedback in most browsers is in the form of a spinning logo at the top right part or an expanding strip at the bottom or at the status bar.</p>

<p>Here comes <a href="http://en.wikipedia.org/wiki/Ajax_%28programming%29">Ajax</a>. With Ajax you can do away with refreshing everything and update only a portion of your page. Unlike the page-based model, the browser cannot give feedback that something is going on after an Ajax-based action. No more spinning logo. No more expanding strip bar. We went backward in interface design.</p>

<p>Fortunately, there is a way to give feedback that requires writing code <a href="http://www.amazon.com/exec/obidos/ASIN/0321472667/gaboogle-20">using JavaScript</a>. It could be as simple as writing a message &ldquo;Loading&hellip;&rdquo; on the page or using an animated GIF file. One implementation would be just to show a previously hidden text or image or create an &lsquo;img&rsquo; element and append it to where you want to display (usually a &lsquo;div&rsquo; element). Many web applications nowadays use various style of animation but the key idea is the same — <a href="http://mentalized.net/activity-indicators/">a smoothly looping animation to indicate an activity</a>.</p>

<p>Animated activity indicators are useful for tasks that will incur short delays. If the delay takes too long, the user may think the application is going on circles or has become a zombie. For longer delays, it is best to show how much progress has been made, an estimate of time remaining, or a sequence of messages telling the user what&rsquo;s happening at the present. This is very useful but tricky to implement because HTTP requests don&rsquo;t give tracking information at regular intervals. If you are making a sequence of 4 requests, you can guesstimate that progress is 25% done when the 1st call has completed. Flickr uses the best activity indicator I&rsquo;ve seen so far when uploading images. Image files are usually big and Flickr does a great job of giving progress feedback to its users — an overall progress and a per-file progress indicator.</p>

<p><a data-flickr-embed="true"  href="https://www.flickr.com/photos/gregmoreno/1501760403/" title="file_upload_progress_flickr"><img src="https://c1.staticflickr.com/3/2056/1501760403_d2581c2298.jpg" width="457" height="336" alt="file_upload_progress_flickr"></a><script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"></script></p>

<p>During the modem days, it is acceptable that many sites are slow given the hardware limitation. But now in the broadband era, amplified by tons of marketing, users expect websites to be lightning fast.</p>

<p>Nobody wants a slow website. But when the user say it is slow, oftentimes, it is because nothing is happening on the screen.</p>

	</section>
	<span class="post-meta">07 Oct 2007</span>


    </article>

  
    <article class="post">
      
	
	<header class="post-header">
		<h2 class="post-title">
			
			<a href="/the-conspiracy-against-user-friendly-software/">
			
				The Conspiracy Against User-friendly Software</a>
		</h2>
	</header>
	<section class="post-excerpt">
		<p>How to design a user-friendly software:
1. Test the design
2. Identify the problems
3. Modify the design
4. Repeat step 1</p>

<p>Sounds easy, right? That is until time pressure, individual preference, market forces and other factors come in and conspire against the design.</p>

<p><a data-flickr-embed="true"  href="https://www.flickr.com/photos/gregmoreno/1378819012/" title="upgrade_equals_money"><img src="https://c1.staticflickr.com/2/1102/1378819012_074f5ab000.jpg" width="500" height="375" alt="upgrade_equals_money"></a><script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"></script></p>

<p>The most common business model for software is to regulary release versions of a product, where each release contains more features than the previous. The new features give customers reason to open their wallets and upgrade their software. Ideally, the new version keeps the good features and adds more good features.</p>

<p>Ideally.</p>

<p>When a new version is released, the design of the next version has already started. From a business perspective, this is a good strategy because the company can keep releasing new features. From a design perspective, gathering and understanding feedback from actual users seldom happens, which is a necessary step to improve the product. Without feedback, the designers would not know that users are having problems printing in landscape or they can&rsquo;t find the spell checking tool anymore. What used to be a simple thing to do now becomes a source of confusion.</p>

<p>Making features available, it seems, is not a difficult thing to do. There is no physical limit in how many items a menu group can contain or how deeply nested your menus are, or how many buttons you use. If your designing a web application, you can include a hundred links in a page and Firefox won&rsquo;t complain.</p>

<p>The difficult part is deciding what goes where. What menu group should this be included with? Would this be part of the standard toolbar? Should it be introduced in a flash screen? Should this be at the top, middle, or at the bottom of the list? Even though there is unlimited space for every feature, every feature competes with each other for user&rsquo;s attention. An item on top of a menu list is more accessible than the items at the bottom. It is not uncommon for users to suggest or complain that the feature they often use should be at the top of the menu list.</p>

<p>More features also mean more options for the users. If the additional features are for accomplishing different tasks, it does not present a problem to the users, for example, saving a document and printing it. But if you give the users many options to accomplish a single task, it would require extra brain processing. In the case of printing, possible options include page size, number of pages in a sheet, print range, orientation, and color. Every time you give users a choice, they have to think about something and make a decision.</p>

<p><a data-flickr-embed="true"  href="https://www.flickr.com/photos/gregmoreno/1378933242/" title="software_kaboom"><img src="https://c1.staticflickr.com/2/1067/1378933242_b8647a9bfd.jpg" width="500" height="375" alt="software_kaboom"></a><script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"></script></p>

<p>Features not only affect design but also the integrity of the software. As developers add more features, they also put in new code. The new code not only has the responsibility to implement the new features but also not to damage existing ones. As the code grows, complexity rises exponentially thus making it difficult to add new code and preserve the integrity at the same time.</p>

<p>Business strategy is not the only factor that can work against a user-friendly software. Sometimes, the designers also work against good design. Making things better is a noble goal but sometimes it gets confused with simply making things different. A designer involved in several iterations of a product has the innate pressure to make things different from the previous. When you hear designers suggest a redesign, it <a href="http://www.alistapart.com/articles/redesignrealign">should only be done if it is aligned with making things better</a> like improving navigation, decreasing task completion time, or improving quality of search results.</p>

<p>Design is often confused with aesthetics. If you survey the job requirements from companies looking for web designers, the primary requirement is often an expertise in Adobe Photoshop. Aesthetics will make the design pleasing to the eye but may make it less comfortable to use. Usability can make the interface comfortable to use but can be uglier. New technology, like <a href="http://en.wikipedia.org/wiki/Ajax_%28programming%29">Ajax</a>, can make the software more responsive but could be at the expense of aesthetics and usability.</p>

<p>Making aesthetics a priority is not confined to interface design. It is everywhere. We buy alarm clocks that looks beautiful but has unreadable numbers, or phones with vibrant colors but with a small keypad. When we moved to our new office, an admin staff asked what I think about our work area. I said the work area is too crowded and our developers would always hit the guy behind him when he stretches his arm. Puzzled, she was actually asking if I like the colors of the wall. Because if not, they will change it. But the alloted space for each developer would remain.</p>

<p><a data-flickr-embed="true"  href="https://www.flickr.com/photos/gregmoreno/1379486588/" title="Redesign and realign"><img src="https://c1.staticflickr.com/2/1177/1379486588_11a9e9ff31.jpg" width="500" height="375" alt="Redesign and realign"></a><script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"></script></p>

<p>This is not to say that decoration is unimportant. Used properly, decoration can guide the users to help them achieve their goal. <a href="http://www.amazon.com/exec/obidos/ASIN/1592530079/gaboogle-20">Aesthetics can help increase the probability of software or website being used, whether or not it is actually easier to use</a>. A more accessible and usable product may suffer lack of acceptance making a noble goal, e.g. accessibility, useless in the absence of an effective visual presentation.</p>

<p>It is our nature to be biased towards attractive things — Nokia cellphones, iPod, BMW, and Paris Hilton. It is no secret that movie actors and actresses receive more attention and that, all other variables being equal, attractive people are preferred in hiring decisions. Attractive things also foster positive attitudes like affection, loyalty, and patience making people more tolerant of design problems. Even though an attractive software is not user-friendly, it can still become successful because once we liked something, our natural talent to adapt kicks in. When we are hook, forcibly or by choice, we find ways to adjust with the unusable interface. Over time, the interface becomes natural to us even though a 5-step task can be redesigned to become 2.</p>

<p>When users are already conditioned to do things in a certain way, design improvements can have negative results if not managed properly. In the case of web applications, the ability to make quick updates immediately available to users is a double-edge sword. Adding <a href="http://www.lukew.com/ff/entry.asp?579">inline validation</a> in the order-entry form will improve user experience but reorganizing the flow of the pages will present problems to users even though the change, as the designers see it, is an improvement.</p>

<p>The problem is designers often think of themselves as typical users. Even though design discussions revolved around &ldquo;what if the user wants to&hellip;&rdquo; and &ldquo;i think the user will be confused if&hellip;&rdquo;,  it is our nature to project our own beliefs onto others. What designers think as improvement to the user&rsquo;s experience is often just a result of his own biases. While the designer may be correct, designs that are product of internal discussions should be done if it matches the results of study with actual users. The are ways to involve the users as early as possible like releasing prototypes or chunking the interface into several iterations.</p>

<p>There is always the desire to make users happy. Still, designs can go wrong. One reason designs go wrong is the people involve have become so proficient in what they are building that they can no longer perceive the areas that can cause trouble to the user. Designers know too much and are accustomed to the software that no matter how hard they try, they can no longer put themselves in the role of a viewer. Predicting all the problem users will have, or the errors that will get made is an impossible task. The only way to know these problems and errors is to observe users and learn what they do. While designers are expert in the software they are working on, users are expert in the task they are trying to perform with the software.</p>

<p>Sometimes, teams are not allowed to talk to end users. The most common reason is fear of the designers telling the users too much. Sometimes, teams work for clients who may be concern about price and schedule but not on usability. Often, designers depend only on requirements that have been filtered by the people from marketing, support, and from the office of the CTO and CEO who all believe they have a better understanding of what the users want. Sometimes, they also have an opinion on how things should be designed which aggravates the situation the designers are into.</p>

<p>Design failures also happen when it is done not by designers but by programmers (sometimes by managers). Programmers know the value of simplicity in implementation and all things being equal, they would rather do the simplest solution that would work. This is a sound principle because as code grows, complexity rises exponentially. By implementing simple solutions, code becomes less costly to maintain. When one design option requires more code than the other, it is just natural for programmers to choose the design that requires less code to implement.</p>

<p><a data-flickr-embed="true"  href="https://www.flickr.com/photos/gregmoreno/1378819602/" title="boy_girl"><img src="https://c1.staticflickr.com/2/1242/1378819602_bfb3e66451.jpg" width="500" height="375" alt="boy_girl"></a><script async src="//embedr.flickr.com/assets/client-code.js" charset="utf-8"></script></p>

<p>The factors working against good design are not hurdles that can be solved by a technical solution. Designing user-friendly software starts with the right mindset. It is very common for technical people to call users stupid every time they receive a complain for what is seemingly a trivial task. In this kind environment, no user-friendly software will ever get produced.</p>

<p>Some think good design is just common sense. While it is true that knowledge of <a href="http://en.wikipedia.org/wiki/Quantum_mechanics">quantum mechanics</a> is not a prerequisite to good design, thinking that design is just common sense leads us to believe that we know what users want. We can guess and try as hard as we can but only by asking and observing users we will know what they want and the problems they are facing.</p>

<p>The right mindset knows that users are different and exactly opposite of you. What is easy for you, is hard for them. What is trivial for you, takes a lot of time for them.  Users don&rsquo;t think the same, don&rsquo;t act the same, and don&rsquo;t have the same experience as you do.</p>

	</section>
	<span class="post-meta">14 Sep 2007</span>


    </article>


<nav class="pagination" role="pagination">
  
    <a class="newer-posts" href="/posts/2"> ← Newer Posts </a>
  

  <span class="page-number">
    Page 3 of 4
  </span>

  
    <a class="older-posts"
        href="/posts/4">
      Older Posts →
    </a>
  
</nav>


  </main>
  <footer class="site-footer"><a class="subscribe icon-feed" href="http:///atom.xml"><span class="tooltip">Subscribe!</span></a>


<div class="inner">









<section class="copyright">All content copyright <a href="/">Greg Moreno</a> © 2019 • All rights reserved.</section>

<section class="poweredby">Casper theme by <a class="icon-ghost" href="http://tryghost.org">Ghost</a> &amp; Published with <a href="http://octopress.org">Octopress</a></section>

</div>
</footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>






</body>
</html>
